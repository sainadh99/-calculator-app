name: CI/CD Pipeline
 
on:
  push:
    branches:
      - master           # Run on push to master
  pull_request:
    types: [closed]      # Run when PR is closed (merged or not)
  workflow_dispatch:      # Allow manual run
 
jobs:
  build-and-deploy:
    # ‚úÖ Conditions:
    # 1. Push directly to master
    # 2. OR merged PR into master AND merger is sainadh99 (PR can be by anyone)
    # 3. OR code changes in PR (opened/synchronized)
    if: |
      github.event_name == 'push' ||
      (
        github.event_name == 'pull_request' &&
        github.event.pull_request.merged == true &&
        github.base_ref == 'master' &&
        github.actor == 'sainadh99'
      ) ||
      (
        github.event_name == 'pull_request' &&
        (github.event.action == 'opened' || github.event.action == 'synchronize')
      )
    runs-on: ubuntu-latest
 
    steps:
      # Step 0: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
 
      # Step 1: Generate Build Number
      - name: Generate Build Number
        id: build_number
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "üî¢ Build Number: $BUILD_NUMBER"
 
      # Step 2: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
 
      # Step 3: Login to DockerHub
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
 
      # Step 4: Build & push Docker image
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            sainadh99/calculator-app:latest
            sainadh99/calculator-app:build-${{ env.BUILD_NUMBER }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
 
      # Step 5: Verify secrets
      - name: Verify Configuration
        run: |
          echo "‚úÖ Checking required secrets..."
          echo "AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST != '' && 'SET' || 'MISSING' }}"
          echo "AZURE_VM_USERNAME: ${{ secrets.AZURE_VM_USERNAME != '' && 'SET' || 'MISSING' }}"
          echo "AZURE_VM_PASSWORD: ${{ secrets.AZURE_VM_PASSWORD != '' && 'SET' || 'MISSING' }}"
          echo "DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME != '' && 'SET' || 'MISSING' }}"
          echo "DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN != '' && 'SET' || 'MISSING' }}"
          echo ""
          echo "üî¢ Build Number: ${{ env.BUILD_NUMBER }}"
 
      # Step 6: Install Docker on VM (if needed)
      - name: Setup Docker on Azure VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          port: 22
          timeout: 300s
          command_timeout: 10m
          script: |
            echo "=== Checking Docker installation ==="
            if ! command -v docker &> /dev/null; then
                echo "Installing Docker..."
                echo "${{ secrets.AZURE_VM_PASSWORD }}" | sudo -S apt update
                echo "${{ secrets.AZURE_VM_PASSWORD }}" | sudo -S apt install -y docker.io
                echo "${{ secrets.AZURE_VM_PASSWORD }}" | sudo -S systemctl start docker
                echo "${{ secrets.AZURE_VM_PASSWORD }}" | sudo -S systemctl enable docker
                echo "${{ secrets.AZURE_VM_PASSWORD }}" | sudo -S usermod -aG docker $USER
            else
                echo "Docker is already installed"
                echo "${{ secrets.AZURE_VM_PASSWORD }}" | sudo -S systemctl start docker || true
            fi
            docker --version || echo "‚ö†Ô∏è Docker command not available"
 
      # Step 7: Deploy to Azure VM
      - name: Deploy to Azure VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          script: |
            echo "=== Starting deployment - Build #${{ env.BUILD_NUMBER }} ==="
            echo "${{ secrets.AZURE_VM_PASSWORD }}" | sudo -S systemctl start docker || true
            sleep 5
 
            if docker info >/dev/null 2>&1; then
                DOCKER_CMD="docker"
            elif echo "${{ secrets.AZURE_VM_PASSWORD }}" | sudo -S docker info >/dev/null 2>&1; then
                DOCKER_CMD="echo '${{ secrets.AZURE_VM_PASSWORD }}' | sudo -S docker"
            else
                echo "‚ùå Docker is not accessible"
                exit 1
            fi
 
            eval "$DOCKER_CMD pull sainadh99/calculator-app:latest"
            eval "$DOCKER_CMD stop calculator-app" 2>/dev/null || true
            eval "$DOCKER_CMD rm calculator-app" 2>/dev/null || true
            eval "$DOCKER_CMD image prune -f"
            eval "$DOCKER_CMD run -d --name calculator-app --restart unless-stopped -p 80:80 sainadh99/calculator-app:latest"
 
            sleep 5
            if eval "$DOCKER_CMD ps" | grep calculator-app; then
                echo "‚úÖ Deployment successful - Build #${{ env.BUILD_NUMBER }}!"
            else
                echo "‚ùå Deployment failed!"
                eval "$DOCKER_CMD logs calculator-app"
                exit 1
            fi
 
      # Step 8: Health check
      - name: Health Check
        run: |
          echo "Waiting for app..."
          sleep 20
          for url in "http://${{ secrets.AZURE_VM_HOST }}" "http://${{ secrets.AZURE_VM_HOST }}:80"; do
            if curl -fs "$url" >/dev/null; then
              echo "‚úÖ App is running at $url"
              exit 0
            fi
          done
          echo "‚ö†Ô∏è App might be running but health check failed. Please verify manually."
 
      # Step 9: Deployment notification
      - name: Deployment Success Notification
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üìä Summary:"
          echo "  ‚Ä¢ Build Number: #${{ env.BUILD_NUMBER }}"
          echo "  ‚Ä¢ Trigger: ${{ github.event_name }}"
          echo "  ‚Ä¢ Branch: ${{ github.ref_name }}"
          echo "  ‚Ä¢ Commit: ${{ github.sha }}"
          echo "  ‚Ä¢ Actor: ${{ github.actor }}"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "  ‚Ä¢ PR #${{ github.event.pull_request.number }} by ${{ github.event.pull_request.user.login }}"
          fi
          echo "  ‚Ä¢ App URL: http://${{ secrets.AZURE_VM_HOST }}"
