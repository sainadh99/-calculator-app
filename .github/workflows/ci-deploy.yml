name: Secure CI/CD Pipeline

on:
  pull_request:
    types: [closed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
      # ---------------------------
      # 1Ô∏è‚É£ Checkout code
      # ---------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------
      # 2Ô∏è‚É£ Generate Build Metadata
      # ---------------------------
      - name: Generate Build Number & Metadata
        id: build_number
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          BUILD_TAG="build-${BUILD_NUMBER}"
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "BUILD_TAG=$BUILD_TAG" >> $GITHUB_ENV
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV

      # ---------------------------
      # 3Ô∏è‚É£ Docker Login
      # ---------------------------
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ---------------------------
      # 4Ô∏è‚É£ Build & Push Docker Image
      # ---------------------------
      - name: Build & Push Docker Image
        run: |
          docker build -t sainadh99/calculator-app:latest \
                      -t sainadh99/calculator-app:${{ env.BUILD_TAG }} \
                      --build-arg BUILD_NUMBER=${{ env.BUILD_NUMBER }} \
                      --build-arg BUILD_DATE=${{ env.BUILD_DATE }} \
                      --build-arg GIT_COMMIT=${{ github.sha }} .
          docker push sainadh99/calculator-app:latest
          docker push sainadh99/calculator-app:${{ env.BUILD_TAG }}

      # ---------------------------
      # 5Ô∏è‚É£ Deploy Secure Container
      # ---------------------------
      - name: Deploy Secure Container
        run: |
          # Install Docker if not available
          if ! command -v docker &> /dev/null; then
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
          fi
          
          # Stop and remove previous container
          docker stop calculator-app 2>/dev/null || true
          docker rm calculator-app 2>/dev/null || true
          
          # Pull latest image
          docker pull sainadh99/calculator-app:${{ env.BUILD_TAG }}
          
          # Create network if it doesn't exist
          docker network inspect calc-network >/dev/null 2>&1 || \
            docker network create --driver bridge calc-network
          
          # Deploy with Docker security restrictions
          docker run -d --name calculator-app --restart unless-stopped \
            --network calc-network \
            -p 80:3000 \
            --memory=512m \
            --cpus=1.0 \
            --pids-limit=100 \
            --security-opt no-new-privileges:true \
            --cap-drop ALL \
            --cap-add NET_BIND_SERVICE \
            --cap-add SETGID \
            --cap-add SETUID \
            --hostname calculator-app \
            --env NODE_ENV=production \
            --env PORT=3000 \
            --health-cmd="curl -f http://localhost:3000/ || exit 1" \
            --health-interval=30s \
            --health-timeout=10s \
            --health-retries=3 \
            --health-start-period=60s \
            --log-driver json-file \
            --log-opt max-size=10m \
            --log-opt max-file=3 \
            sainadh99/calculator-app:${{ env.BUILD_TAG }}

      # ---------------------------
      # 6Ô∏è‚É£ Docker Security Validation
      # ---------------------------
      - name: Docker Security Validation
        run: |
          echo "üîí Docker Security Validation Report"
          echo "======================================"
          
          # Check if container is running
          if ! docker ps | grep -q calculator-app; then
            echo "‚ùå Container is not running - security validation failed"
            exit 1
          fi
          
          echo "‚úÖ Container Status: Running"
          
          # Validate security configurations
          echo ""
          echo "üõ°Ô∏è Security Configuration Audit:"
          echo "--------------------------------"
          
          # Check capabilities
          echo ""
          echo "üîê Capability Analysis:"
          CAPS=$(docker inspect calculator-app --format='{{.HostConfig.CapDrop}}' 2>/dev/null)
          if [[ "$CAPS" =~ "ALL" ]]; then
            echo "‚úÖ All capabilities dropped"
            ADDED_CAPS=$(docker inspect calculator-app --format='{{.HostConfig.CapAdd}}' 2>/dev/null)
            echo "   Added capabilities: $ADDED_CAPS"
          else
            echo "‚ùå Security Risk: Not all capabilities dropped"
          fi
          
          # Check security options
          echo ""
          echo "üîí Security Options:"
          SECURITY_OPTS=$(docker inspect calculator-app --format='{{range .HostConfig.SecurityOpt}}{{.}} {{end}}' 2>/dev/null)
          echo "   Active security options: $SECURITY_OPTS"
          
          if [[ "$SECURITY_OPTS" =~ "no-new-privileges:true" ]]; then
            echo "‚úÖ Privilege escalation blocked"
          else
            echo "‚ùå Security Risk: Privilege escalation not blocked"
          fi
          
          # Check resource limits
          echo ""
          echo "‚ö° Resource Limits:"
          MEMORY_LIMIT=$(docker inspect calculator-app --format='{{.HostConfig.Memory}}' 2>/dev/null)
          CPU_LIMIT=$(docker inspect calculator-app --format='{{.HostConfig.NanoCpus}}' 2>/dev/null)
          PIDS_LIMIT=$(docker inspect calculator-app --format='{{.HostConfig.PidsLimit}}' 2>/dev/null)
          
          echo "   Memory limit: $((MEMORY_LIMIT / 1024 / 1024))MB"
          echo "   CPU limit: $((CPU_LIMIT / 1000000000)) cores"
          echo "   PIDs limit: $PIDS_LIMIT"
          
          if [ "$MEMORY_LIMIT" -gt 0 ] && [ "$CPU_LIMIT" -gt 0 ] && [ "$PIDS_LIMIT" -gt 0 ]; then
            echo "‚úÖ Resource limits properly configured"
          else
            echo "‚ö†Ô∏è Warning: Some resource limits may not be set"
          fi
          
          # Check network isolation
          echo ""
          echo "üåê Network Security:"
          NETWORK_MODE=$(docker inspect calculator-app --format='{{.HostConfig.NetworkMode}}' 2>/dev/null)
          echo "   Network mode: $NETWORK_MODE"
          
          if [ "$NETWORK_MODE" = "calc-network" ]; then
            echo "‚úÖ Custom isolated network"
          elif [ "$NETWORK_MODE" = "host" ]; then
            echo "‚ö†Ô∏è Warning: Host network mode (reduced isolation)"
          else
            echo "‚ùì Network mode: $NETWORK_MODE"
          fi
          
          # Check for privileged mode
          echo ""
          echo "üö´ Privilege Check:"
          PRIVILEGED=$(docker inspect calculator-app --format='{{.HostConfig.Privileged}}' 2>/dev/null)
          if [ "$PRIVILEGED" = "false" ]; then
            echo "‚úÖ Non-privileged container"
          else
            echo "‚ùå CRITICAL: Container running in privileged mode!"
          fi
          
          # Final security score
          echo ""
          echo "üìä Security Score Calculation:"
          echo "=============================="
          
          SECURITY_SCORE=0
          MAX_SCORE=8
          
          # Score components
          [[ "$CAPS" =~ "ALL" ]] && SECURITY_SCORE=$((SECURITY_SCORE + 2)) && echo "‚úÖ Capabilities dropped (+2)"
          [[ "$SECURITY_OPTS" =~ "no-new-privileges" ]] && SECURITY_SCORE=$((SECURITY_SCORE + 2)) && echo "‚úÖ Privilege escalation blocked (+2)"
          [ "$PRIVILEGED" = "false" ] && SECURITY_SCORE=$((SECURITY_SCORE + 2)) && echo "‚úÖ Non-privileged (+2)"
          [ "$MEMORY_LIMIT" -gt 0 ] && SECURITY_SCORE=$((SECURITY_SCORE + 1)) && echo "‚úÖ Resource limits (+1)"
          [ "$NETWORK_MODE" != "host" ] && SECURITY_SCORE=$((SECURITY_SCORE + 1)) && echo "‚úÖ Network isolation (+1)"
          
          echo ""
          echo "üéØ Final Security Score: $SECURITY_SCORE/$MAX_SCORE"
          
          if [ "$SECURITY_SCORE" -ge 6 ]; then
            echo "üéâ EXCELLENT: Container security is properly configured"
          elif [ "$SECURITY_SCORE" -ge 4 ]; then
            echo "‚úÖ GOOD: Container security is acceptable"
          else
            echo "‚ùå CRITICAL: Container security is insufficient"
            exit 1
          fi
          
          echo ""
          echo "üîí Security validation completed successfully"

      # ---------------------------
      # 7Ô∏è‚É£ Container Health Check
      # ---------------------------
      - name: Container Health Check
        run: |
          echo "üîç Container Health Check..."
          
          # Wait for container to initialize
          echo "‚è≥ Waiting 30 seconds for container to initialize..."
          sleep 30
          
          # Check container status
          echo "üìã Container status:"
          docker ps -a --filter name=calculator-app --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # Check container health
          echo "üè• Container health status:"
          docker inspect calculator-app --format='{{.State.Health.Status}}' 2>/dev/null || echo "No health status available"
          
          # Verify container is running
          if ! docker ps | grep -q calculator-app; then
            echo "‚ùå Container is not running!"
            docker logs calculator-app
            exit 1
          fi
          
          echo "‚úÖ Container is healthy and running"

      # ---------------------------
      # 8Ô∏è‚É£ Container Maintenance
      # ---------------------------
      - name: Container Maintenance
        run: |
          echo "üßπ Cleaning up old containers..."
          docker container prune -f
          
          echo "üßπ Cleaning up old images..."
          # Keep only latest and current build
          docker images sainadh99/calculator-app --format "{{.Repository}}:{{.Tag}} {{.ID}}" | \
            grep -v ":latest" | \
            grep -v ":${{ env.BUILD_TAG }}" | \
            awk '{print $1}' | \
            while read -r image; do
              if [ -n "$image" ]; then
                echo "Removing: $image"
                docker rmi "$image" --force 2>/dev/null || echo "Failed to remove $image"
              fi
            done
          
          # Clean up dangling images
          docker image prune -f
          
          echo "‚úÖ Maintenance completed"

      # ---------------------------
      # 9Ô∏è‚É£ Deployment Success Notification
      # ---------------------------
      - name: Deployment Success Notification
        run: |
          echo "üéâ Deployment successful!"
          echo "üè∑Ô∏è Version: ${{ env.BUILD_TAG }}"
          echo "üì¶ App: Calculator App (Docker Security Focused)"
          echo "üîí Docker Security Features:"
          echo "   ‚Ä¢ All capabilities dropped (minimal required restored)"
          echo "   ‚Ä¢ No privilege escalation (no-new-privileges)"
          echo "   ‚Ä¢ Non-privileged container"
          echo "   ‚Ä¢ Resource limits (512MB RAM, 1.0 CPU, 100 PIDs)"
          echo "   ‚Ä¢ Isolated network with custom bridge"
          echo "   ‚Ä¢ Container health monitoring"
          echo "   ‚Ä¢ Automated security validation"
          echo "‚è∞ Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
