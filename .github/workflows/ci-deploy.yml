name: CI/CD Pipeline

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, closed]
  workflow_dispatch:

jobs:
  build-and-deploy:
    if: |
      (
        github.event_name == 'push' && 
        github.ref == 'refs/heads/master' && 
        !contains(github.event.head_commit.message, 'Merge pull request')
      ) || 
      (
        github.event_name == 'pull_request' && 
        github.event.pull_request.merged == true && 
        github.base_ref == 'master'
      ) || 
      (
        github.event_name == 'pull_request' && 
        (github.event.action == 'opened' || github.event.action == 'synchronize')
      ) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      # Step 0: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 1: Generate Build Number
      - name: Generate Build Number
        id: build_number
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "üî¢ Build Number: $BUILD_NUMBER"

      # Step 2: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Login to DockerHub
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Step 4: Build & push Docker image
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            sainadh99/calculator-app:latest
            sainadh99/calculator-app:build-${{ env.BUILD_NUMBER }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Step 5: Verify secrets
      - name: Verify Configuration
        run: |
          echo "‚úÖ Checking required secrets..."
          echo "GCP_VM_HOST: ${{ secrets.GCP_VM_HOST != '' && 'SET' || 'MISSING' }}"
          echo "GCP_VM_USERNAME: ${{ secrets.GCP_VM_USERNAME != '' && 'SET' || 'MISSING' }}"
          echo "GCP_VM_KEY: ${{ secrets.GCP_VM_KEY != '' && 'SET' || 'MISSING' }}"
          echo "DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME != '' && 'SET' || 'MISSING' }}"
          echo "DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN != '' && 'SET' || 'MISSING' }}"
          echo ""
          echo "üî¢ Build Number: ${{ env.BUILD_NUMBER }}"
          echo "üîÑ Trigger: ${{ github.event_name }}"
          echo "üë§ Actor: ${{ github.actor }}"

      # Step 6: Setup SSH key for GCP VM
      - name: Setup SSH key
        run: |
          echo "${{ secrets.GCP_VM_KEY }}" > gcp_key
          chmod 600 gcp_key

      # Step 7: Install Docker on GCP VM (if needed)
      - name: Setup Docker on GCP VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USERNAME }}
          key: ${{ secrets.GCP_VM_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 10m
          script: |
            echo "=== Checking Docker installation ==="
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo apt update
              sudo apt install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker $USER
            else
              echo "Docker is already installed"
              sudo systemctl start docker || true
            fi
            docker --version || echo "‚ö†Ô∏è Docker command not available"

      # Step 8: Deploy to GCP VM
      - name: Deploy to GCP VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USERNAME }}
          key: ${{ secrets.GCP_VM_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          script: |
            echo "=== Starting deployment - Build #${{ env.BUILD_NUMBER }} ==="
            sudo systemctl start docker || true
            sleep 5
            
            if docker info >/dev/null 2>&1; then
              DOCKER_CMD="docker"
            elif sudo docker info >/dev/null 2>&1; then
              DOCKER_CMD="sudo docker"
            else
              echo "‚ùå Docker is not accessible"
              exit 1
            fi
            
            eval "$DOCKER_CMD pull sainadh99/calculator-app:latest"
            eval "$DOCKER_CMD stop calculator-app" 2>/dev/null || true
            eval "$DOCKER_CMD rm calculator-app" 2>/dev/null || true
            eval "$DOCKER_CMD image prune -f"
            eval "$DOCKER_CMD run -d --name calculator-app --restart unless-stopped -p 80:80 sainadh99/calculator-app:latest"
            
            sleep 5
            if eval "$DOCKER_CMD ps" | grep calculator-app; then
              echo "‚úÖ Deployment successful - Build #${{ env.BUILD_NUMBER }}!"
            else
              echo "‚ùå Deployment failed!"
              eval "$DOCKER_CMD logs calculator-app"
              exit 1
            fi

      # Step 9: Health check
      - name: Health Check
        run: |
          echo "Waiting for app..."
          sleep 20
          for url in "http://${{ secrets.GCP_VM_HOST }}" "http://${{ secrets.GCP_VM_HOST }}:80"; do
            if curl -fs "$url" >/dev/null; then
              echo "‚úÖ App is running at $url"
              exit 0
            fi
          done
          echo "‚ö†Ô∏è App might be running but health check failed. Please verify manually."

      # Step 10: Deployment notification
      - name: Deployment Success Notification
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üìä Summary:"
          echo "  ‚Ä¢ Build Number: #${{ env.BUILD_NUMBER }}"
          echo "  ‚Ä¢ Trigger: ${{ github.event_name }}"
          echo "  ‚Ä¢ Branch: ${{ github.ref_name }}"
          echo "  ‚Ä¢ Commit: ${{ github.sha }}"
          echo "  ‚Ä¢ Actor: ${{ github.actor }}"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "  ‚Ä¢ PR #${{ github.event.pull_request.number }} by ${{ github.event.pull_request.user.login }}"
          fi
          echo "  ‚Ä¢ App URL: http://${{ secrets.GCP_VM_HOST }}"
